<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">
    <title>Crypto QR</title>
    
    
    
    <script type="module">
        import {encrypt, decrypt} from './crypto.mjs'
        
        let form = document.forms[0]
        let qr = document.getElementById('qr')
        
        
        if (('BarcodeDetector' in window) && ((await BarcodeDetector.getSupportedFormats()).includes('qr_code'))) {
            log('QR code scanning is supported.')
        } else {
            log('QR code scanning is NOT supported.')
        }
        
        form.onsubmit = handleSubmit

        function log(text) {
            form.elements.log.value = text
        }
        
        async function handleSubmit(event) {
            event.preventDefault()
            if(event.submitter.value == "send") {
                const message = form.elements.message.value
                const cryptoblob = await encrypt(message)
                const data = await cryptoblob.text()
                const response = await fetch('https://api.qrserver.com/v1/create-qr-code/?data=' + data)
                const blob =  await response.blob()
                const objectURL = URL.createObjectURL(blob)
                qr.src = objectURL
            }
            
            if(event.submitter.value == "receive") {
                try {
                    log('Attempting to read qr code')
                    let barcodeDetector = new BarcodeDetector({formats: ['qr_code']})
                    let barcodes = await barcodeDetector.detect(qr)
                    
                } catch (error) {
                    log(error)
                }
               
            }
        }   
        
        
    </script>
    
    <style>
        form, img {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 500px;
            margin: auto;
            padding: 3rem;
        }
        
    </style>    
</head>
<body>
    <form>
        <label for="message">Message:</label>
        <textarea id="message" name="message" rows="8"></textarea>
        <label for="log">log:</label>
        <output id="log" name="log"></output>
        <button type="submit" value="send">Create QR</button>
        <button type="submit" value="receive">Read QR</button>
    </form>
    
    <img id="qr">
    
</body>
</html>
